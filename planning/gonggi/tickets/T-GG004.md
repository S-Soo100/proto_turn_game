# 변칙 룰 엔진 구현

| 항목 | 값 |
|---|---|
| **ID** | T-GG004 |
| **에픽** | E-GG001 |
| **게임** | gonggi |
| **상태** | draft |
| **우선순위** | high |
| **담당** | claude |
| **생성일** | 2026-03-01 |
| **수정일** | 2026-03-01 |
| **브랜치** | feature/T-GG004-chaos-engine |
| **의존** | T-GG001 |
| **차단** | T-GG005, T-GG006 |

---

## 요약

> 변칙 룰 발동 판정, 확률 계산, 룰 등록/실행을 담당하는 엔진을 순수 함수로 구현한다.

## 상세 설명

### ChaosEngine 핵심 구조
```typescript
interface ChaosRule {
  id: string
  name: string
  trigger: 'after-toss' | 'before-pick' | 'before-success' | 'stage-transition'
  minRound: number
  probability: number
  execute: (state: GonggiState) => ChaosResult
}

interface ChaosResult {
  type: 'stone-lost' | 'all-stones-scattered' | 'stage-reset' | ...
  animation: string
  message: string
  stateChanges: Partial<GonggiState>
}
```

### 핵심 함수
- `registerRule(rule: ChaosRule)`: 룰 등록 (플러그인 패턴)
- `shouldTrigger(round, trigger, rules)`: 라운드 + 타이밍 기준 발동 판정
- `selectRule(candidates)`: 발동 가능한 룰 중 확률 가중 랜덤 선택
- `applyChaos(state, chaosResult)`: 변칙 룰 결과를 게임 상태에 적용
- `getChaosChance(round)`: 라운드별 변칙 발동 기본 확률 계산

### 확률 테이블
| 라운드 | 기본 확률 | 비고 |
|---|---|---|
| 1~2 | 0% | 신뢰 구축 구간 (절대 발동 안 함) |
| 3 | 30% | |
| 4 | 50% | |
| 5+ | 70~90% | `min(0.7 + (round - 5) * 0.05, 0.9)` |

## 구현 가이드

### 수정할 파일
| 파일 | 변경 내용 |
|---|---|
| `src/lib/game-logic/gonggi-chaos.ts` | **신규** — 변칙 룰 엔진 |
| `src/lib/game-logic/gonggi-chaos.test.ts` | **신규** — Unit 테스트 |

### 참고 패턴
- `reaction-speed.ts`의 `generateSchedule` — seeded RNG로 재현 가능한 랜덤
- `tictactoe.ts`의 순수 함수 구조 — 불변 상태 반환 패턴

## 수락 기준

- [ ] `registerRule`로 룰 등록 시 엔진에 자동 포함
- [ ] 라운드 1~2에서 `shouldTrigger`가 절대 true 반환하지 않음
- [ ] 라운드별 확률 테이블이 정확히 동작
- [ ] `selectRule`이 확률 가중 랜덤으로 룰 선택
- [ ] `applyChaos`가 불변 상태를 반환
- [ ] Unit 테스트 최소 15개
- [ ] `pnpm build` 성공

## 관련 유즈케이스

| ID | 제목 |
|---|---|
| UC-GG001 | 솔로 공기놀이 플레이 |

## 메모

- 엔진은 게임 로직(`gonggi.ts`)에서 호출하되, 변칙 룰 자체는 별도 파일에서 import
- seeded RNG를 사용하면 동일 시드에서 동일 변칙 발동 → 리플레이/테스트에 유리
