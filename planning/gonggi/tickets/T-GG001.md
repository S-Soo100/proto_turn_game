# 공기놀이 게임 로직 구현

| 항목 | 값 |
|---|---|
| **ID** | T-GG001 |
| **에픽** | E-GG001 |
| **게임** | gonggi |
| **상태** | draft |
| **우선순위** | high |
| **담당** | claude |
| **생성일** | 2026-03-01 |
| **수정일** | 2026-03-01 |
| **브랜치** | feature/T-GG001-game-logic |
| **의존** | — |
| **차단** | T-GG002 |

---

## 요약

> 공기놀이의 핵심 게임 로직을 순수 함수로 구현한다. 1단~5단 진행, 성공/실패 판정, 점수 계산을 포함한다.

## 상세 설명

### 게임 상태 (GonggiState)
- `stones`: 공깃돌 5개의 위치와 상태 (바닥/손/공중)
- `stage`: 현재 단계 (1~5)
- `substep`: 현재 단계 내 진행 (예: 1단에서 4번 반복 중 몇 번째)
- `inHand`: 손에 들고 있는 돌 수
- `score`: 점수
- `attempts`: 시도 횟수
- `status`: playing / success / failed

### 핵심 함수
- `createInitialState()`: 초기 상태 생성
- `scatterStones(state)`: 돌 뿌리기 (랜덤 위치)
- `tossStone(state)`: 돌 하나 위로 던지기
- `pickStones(state, count)`: 바닥 돌 집기 (단계별 개수)
- `catchStone(state, success)`: 떨어지는 돌 잡기 성공/실패
- `advanceStage(state)`: 다음 단계로 진행
- `checkResult(state)`: 결과 확인 (진행 중/성공/실패)

## 구현 가이드

### 수정할 파일
| 파일 | 변경 내용 |
|---|---|
| `src/lib/game-logic/gonggi.ts` | **신규** — 게임 로직 |
| `src/lib/game-logic/gonggi.test.ts` | **신규** — Unit 테스트 |

### DB 변경 (해당 시)
```sql
-- Supabase SQL Editor에서 실행
INSERT INTO game_types (id, name, description, board_config, initial_board_state, max_players, active)
VALUES (
  'gonggi',
  '공기놀이',
  '한국 전통 공깃돌 놀이',
  '{"type": "free", "stones": 5}',
  '{"stage": 1, "stones": [], "inHand": 0}',
  2,
  true
);
```

### 참고 패턴
- `reaction-speed.ts`의 seeded RNG 패턴 (돌 뿌리기 위치 결정)
- `tictactoe.ts`의 순수 함수 구조 (불변 상태 반환)

## 수락 기준

- [ ] 1단~5단 전체 플로우가 순수 함수로 구현됨
- [ ] 각 단계별 성공/실패 판정이 정확함
- [ ] Unit 테스트 작성 (최소 20개)
- [ ] `pnpm test:run` 성공
- [ ] `pnpm build` 성공

## 관련 유즈케이스

| ID | 제목 |
|---|---|
| UC-GG001 | 솔로 공기놀이 플레이 |

## 메모

- 조작 방식 확정됨: 타이밍 기반 + 스와이프-투-캐치 + 플릭-투-토스 (상세: `overview.md`)
- 로직에서 필요한 인터페이스:
  - `tossStone`: 플릭 속도/방향 → 체공 시간 계산
  - `pickStones`: 스와이프로 선택된 돌 인덱스 배열 → 올바른 개수인지 검증
  - `catchStone`: 제한시간 내 잡기 성공 여부
  - 각 동작의 제한시간 상수 (단계별 차등)
