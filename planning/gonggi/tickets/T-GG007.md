# 리더보드 구현

| 항목 | 값 |
|---|---|
| **ID** | T-GG007 |
| **에픽** | E-GG001 |
| **게임** | gonggi |
| **상태** | draft |
| **우선순위** | medium |
| **담당** | claude |
| **생성일** | 2026-03-01 |
| **수정일** | 2026-03-01 |
| **브랜치** | feature/T-GG007-leaderboard |
| **의존** | T-GG003 |
| **차단** | — |

---

## 요약

> 공기놀이 클리어 시간을 DB에 저장하고, 순위표(리더보드)를 표시하는 기능을 구현한다.

## 상세 설명

### 기록 항목
| 컬럼 | 타입 | 설명 |
|---|---|---|
| `id` | uuid | PK |
| `user_id` | uuid (FK → profiles) | 플레이어 |
| `clear_time_ms` | integer | 클리어 소요 시간 (ms) |
| `fail_count` | integer | 실패 횟수 (단계 실패 + 변칙 룰) |
| `chaos_survived` | integer | 변칙 룰 생존 횟수 |
| `created_at` | timestamptz | 기록 시점 |

### 리더보드 UI
- 결과 화면 하단에 "리더보드" 버튼
- 표 형태: 순위 | 닉네임 | 클리어 시간 | 실패 | 변칙 생존 | 날짜
- 클리어 시간 ASC 정렬 (빠를수록 상위)
- 내 기록 행 하이라이트
- 상위 20개 표시 + 내 순위가 20위 밖이면 별도 표시

## 구현 가이드

### 수정할 파일
| 파일 | 변경 내용 |
|---|---|
| `src/components/game/GonggiLeaderboard.tsx` | **신규** — 리더보드 테이블 컴포넌트 |
| `src/components/game/GonggiLeaderboard.test.tsx` | **신규** — Integration 테스트 |
| `src/pages/GonggiPage.tsx` | 결과 화면에 리더보드 연동 |
| `src/store/gameStore.ts` 또는 별도 store | 리더보드 데이터 fetch/submit |

### DB 변경
```sql
-- Supabase SQL Editor
CREATE TABLE gonggi_leaderboard (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id uuid REFERENCES profiles(id) NOT NULL,
  clear_time_ms integer NOT NULL,
  fail_count integer DEFAULT 0,
  chaos_survived integer DEFAULT 0,
  created_at timestamptz DEFAULT now()
);

-- RLS
ALTER TABLE gonggi_leaderboard ENABLE ROW LEVEL SECURITY;

-- Anyone can read leaderboard
CREATE POLICY "Leaderboard is public" ON gonggi_leaderboard
  FOR SELECT USING (true);

-- Users can insert own records
CREATE POLICY "Users can insert own records" ON gonggi_leaderboard
  FOR INSERT WITH CHECK (auth.uid() = user_id);

-- Index for fast sorting
CREATE INDEX idx_gonggi_leaderboard_time ON gonggi_leaderboard(clear_time_ms ASC);
```

### 참고 패턴
- `ReactionSpeedPage.tsx`의 result 화면 패턴
- `gameStore.ts`의 Supabase 데이터 연동 패턴

## 수락 기준

- [ ] 5단 클리어 시 자동으로 DB에 기록 저장
- [ ] 리더보드에 상위 20개 기록이 표 형태로 표시
- [ ] 클리어 시간 기준 ASC 정렬
- [ ] 내 기록 행이 하이라이트됨
- [ ] 내 순위가 20위 밖이면 하단에 별도 표시
- [ ] 리더보드 표 컬럼: 순위 / 닉네임 / 클리어 시간 / 실패 횟수 / 변칙 생존 / 날짜
- [ ] `pnpm test:run` 통과
- [ ] `pnpm build` 성공

## 관련 유즈케이스

| ID | 제목 |
|---|---|
| UC-GG001 | 솔로 공기놀이 플레이 |

## 메모

- 클리어 시간 포맷: `MM:SS.mmm` (예: `02:34.567`)
- 변칙 룰 때문에 시간이 늘어나므로, 운이 좋아야 빠른 기록 가능 → 리플레이 동기
- 향후 "일간/주간/전체" 필터 추가 가능 (후속 개선)
